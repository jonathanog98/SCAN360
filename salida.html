
<!doctype html><html lang="es"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Scan360 | Inspección de Salida</title>
<link rel="stylesheet" href="style-scan360-mobile.css"/>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script defer src="env.js"></script>
<script defer src="app.js"></script>
</head><body>
<div class="nav"><div class="nav-inner">
  <div class="logo">Scan360</div>
  <div class="tabs"><div class="tab active">Salida</div></div>
</div></div>
<div class="container">
  <div class="card">
    <h3>Salida <span class="mono" id="status"></span></h3>
    <p><strong>Placa:</strong> <span id="placa"></span></p>
  </div>
  <div class="card">
    <h3>Checklist</h3>
    <div id="form"></div>
  </div>
  <div class="card">
    <h3>Finalizar</h3>
    <label>Entregado por / firmó:
      <input id="salida_by" type="text" placeholder="Nombre del cliente o agente"/>
    </label>
    <div class="actions">
      <label>Fotos de salida:
        <input id="foto_salida" type="file" accept="image/*" multiple/>
      </label>
      <button class="btn primary" id="btnSave">Guardar salida</button>
      <a href="entrada.html"><button class="btn outline">Ir a ENTRADA</button></a>
      <a href="index.html"><button class="btn outline">Inicio</button></a>
    </div>
    <div class="gallery" id="gal_salida"></div>
  </div>
</div>
<script>
  let currentCase=null;
  window.addEventListener('DOMContentLoaded', async ()=>{
    initSupabase();
    const plate=(sessionStorage.getItem('plate')||'').toUpperCase();
    if(!plate) return location.href='index.html';
    document.getElementById('placa').textContent=plate;
    currentCase = await getOrCreateCase(plate);
    document.getElementById('status').textContent=currentCase.status;
    const points = await getPoints(currentCase.id);
    document.getElementById('form').innerHTML = buildSalidaForm(points);
    const fotos = await listPhotos(currentCase.id, 'salida');
    renderPhotos('gal_salida', fotos);
    document.getElementById('btnSave').onclick = async ()=>{
      await saveSalida(currentCase.id, document.getElementById('salida_by').value);
    };
    const input=document.getElementById('foto_salida');
    input.addEventListener('change', async (e)=>{
      for(const f of e.target.files){
        try{ await uploadPhoto(currentCase.id, 'salida', f);}catch(err){ alert(err.message); }
      }
      const fotos2=await listPhotos(currentCase.id,'salida'); renderPhotos('gal_salida', fotos2); input.value='';
    });
  });
</script>
</body></html>
